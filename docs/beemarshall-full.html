<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMarshall - Professional Apiary Logistics</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- BeeMarshall Branding System -->
    <link rel="stylesheet" href="css/brand.css" />
    
    <style>
        /* BeeMarshall Enhanced UI - Following Design Philosophy */
        
        :root {
            /* Hive Design System - Light Yellow, Dark Yellow, White, Black */
            --light-yellow: #FFFACD;
            --dark-yellow: #DAA520;
            --white: #FFFFFF;
            --black: #000000;
            --accent: #FFD700;
            --bg: var(--light-yellow);
            --glass: rgba(255,250,205,0.95);
            --shadow: 0 8px 32px rgba(218,165,32,0.15);
            --radius: 12px;
            --transition: all .22s cubic-bezier(.4,0,.2,1);
            
            /* Hive Color Palette */
            --primary-bg: var(--light-yellow);
            --primary-accent: var(--dark-yellow);
            --secondary-accent: var(--white);
            --text-primary: var(--black);
            --text-secondary: #666666;
            --success: var(--dark-yellow);
            --warning: var(--dark-yellow);
            --danger: #DC3545;
            --info: var(--accent);
            
            /* Enhanced Typography */
            --font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-size-base: 16px;
            --line-height-base: 1.6;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Border Radius */
            --border-radius-sm: 0.375rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced Base Styles */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: var(--font-family);
            background: var(--white);
            color: var(--black);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }
        
        body {
            font-size: var(--font-size-base);
            line-height: var(--line-height-base);
            background: var(--white);
        }
        
        a {
            color: inherit;
            text-decoration: none;
            transition: var(--transition);
        }
        
        a:hover {
            color: var(--accent);
        }
        
        img {
            display: block;
            max-width: 100%;
            height: auto;
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                transition: none !important;
                animation: none !important;
                transform: none !important;
            }
        }
        
        /* Enhanced Button Styles */
        .btn {
            border-radius: var(--radius);
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 8px 22px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--dark-yellow), var(--accent));
            color: var(--black);
            border: 2px solid var(--dark-yellow);
            font-weight: 600;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 12px 28px rgba(218,165,32,0.25);
            background: linear-gradient(135deg, var(--accent), var(--dark-yellow));
        }
        
        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--dark-yellow);
            color: var(--black);
        }
        
        .btn-outline-primary:hover {
            background: var(--dark-yellow);
            border-color: var(--dark-yellow);
            color: var(--black);
        }
        
        /* Enhanced Card Styles - Migration Tool Aesthetic */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            box-shadow: 0 8px 32px rgba(218,165,32,0.15);
            transition: var(--transition);
            backdrop-filter: blur(12px) saturate(1.1);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(218,165,32,0.2);
        }
        
        /* Glass morphism for modals - Migration Tool Aesthetic */
        .modal-content {
            background: var(--white);
            border: 2px solid var(--dark-yellow);
            backdrop-filter: blur(12px) saturate(1.1);
            border-radius: var(--radius);
            box-shadow: 0 8px 32px rgba(218,165,32,0.15);
        }
        
        /* Version Tag Styling */
        .version-tag {
            margin-top: 0.5rem;
        }
        .version-tag .badge {
            background: linear-gradient(135deg, var(--primary-accent), #17a2b8) !important;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        .version-tag .badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Map Placeholder Styling */
        .map-placeholder {
            height: 400px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: var(--primary-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .map-placeholder-content {
            text-align: center;
            z-index: 2;
            position: relative;
        }
        
        .map-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.02) 10px,
                rgba(0,0,0,0.02) 20px
            );
            z-index: 1;
        }
        
        /* Enhanced Form Styles */
        .form-control {
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            transition: var(--transition);
            background: var(--white);
            backdrop-filter: blur(8px);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(218, 165, 32, 0.25);
        }
        
        .form-select {
            border-radius: var(--radius);
            border: 2px solid var(--dark-yellow);
            transition: var(--transition);
            background: var(--white);
            backdrop-filter: blur(8px);
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 0.2rem rgba(218, 165, 32, 0.25);
        }
        
        /* Collapsible cluster filter */
        #clusterFilterOptions {
            transition: all 0.3s ease;
        }
        
        #clusterFilterOptions .btn-group-vertical {
            gap: 0.25rem;
        }
        
        #clusterFilterOptions .btn {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            text-align: left;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #clusterFilterOptions .btn:hover {
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #filterToggleBtn {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
        }
        
        #filterToggleBtn:hover {
            background-color: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            #clusterTypeFilter {
                margin-bottom: 1rem;
            }
            
            #clusterTypeFilter .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            
            #clusterFilterOptions .btn {
                font-size: 0.8rem;
                padding: 0.35rem 0.7rem;
            }
            
            #filterToggleBtn {
                font-size: 0.8rem;
                padding: 0.35rem 0.7rem;
            }
        }
        
        /* Navigation */
        .navbar {
            background: var(--dark-yellow);
            border-bottom: 2px solid var(--black);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Sticky navbar for mobile */
        @media (max-width: 768px) {
            .navbar {
                position: sticky;
                top: 0;
                z-index: 1040;
            }
        }
        
        .navbar.scrolled {
            background: var(--dark-yellow);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: var(--black) !important;
            font-size: 1.5rem;
        }
        
        .nav-link {
            color: var(--black) !important;
            font-weight: 600;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 0.5rem 1rem !important;
        }
        
        .nav-link:hover {
            color: var(--white) !important;
            background: rgba(255,255,255,0.3);
        }
        
        /* Active navigation state */
        .nav-link.active {
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.5) 100%) !important;
            color: var(--black) !important;
            font-weight: 700 !important;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .nav-link.active::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--dark-yellow) 50%, transparent 100%);
            border-radius: 2px 2px 0 0;
        }
        
        .nav-link.active i {
            transform: scale(1.1);
        }
        
        /* Dropdown styling */
        .dropdown-menu {
            background: var(--white);
            border: 2px solid var(--dark-yellow);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            padding: 0.5rem 0;
        }
        
        .dropdown-item {
            color: var(--black);
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            transition: all 0.2s ease;
        }
        
        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--light-yellow) 0%, rgba(255,193,7,0.2) 100%);
            color: var(--black);
            transform: translateX(4px);
        }
        
        .dropdown-item i {
            margin-right: 0.5rem;
        }
        
        .dropdown-divider {
            border-color: var(--dark-yellow);
            opacity: 0.3;
            margin: 0.5rem 0;
        }
        
        /* Cards */
        .card {
            border: none;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            background: var(--primary-bg);
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            background: var(--dark-yellow);
            color: var(--black);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0 !important;
            font-weight: 600;
        }
        
        /* Buttons */
        .btn {
            border-radius: var(--border-radius-md);
            font-weight: 500;
            border: none;
        }
        
        .btn:hover {
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-accent) 0%, #17a2b8 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--dark-yellow) 0%, var(--accent) 100%);
            color: var(--black);
            border: 2px solid var(--dark-yellow);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #F1C40F 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #E67E22 100%);
        }
        
        /* Forms */
        .form-control, .form-select {
            border-radius: var(--border-radius-md);
            border: 2px solid #E9ECEF;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 0.2rem rgba(31, 200, 222, 0.25);
        }
        
        /* Enhanced Dashboard Stats */
        .dashboard-stat-card {
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
            background: var(--glass);
            backdrop-filter: blur(12px) saturate(1.1);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .dashboard-stat-card:hover {
            box-shadow: 0 12px 40px rgba(0,0,0,0.1);
            border-color: var(--accent);
        }
        
        .dashboard-stat-card .card-body {
            position: relative;
            z-index: 2;
            padding: 2rem 1.5rem;
        }
        
        .stat-icon-container {
            margin-bottom: 1rem;
            position: relative;
        }
        
        .stat-icon-container i {
            font-size: 3rem;
            transition: all 0.3s ease;
            display: inline-block;
        }
        
        .dashboard-stat-card:hover .stat-icon-container i {
            transform: scale(1.2) rotate(5deg);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dashboard-stat-card:hover .stat-number {
            color: var(--primary-accent);
        }
        
        .stat-label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0;
        }
        
        .dashboard-stat-card:hover .stat-label {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .stat-action-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            opacity: 0;
        }
        
        .dashboard-stat-card:hover .stat-action-indicator {
            opacity: 1;
        }
        
        .stat-action-indicator i {
            font-size: 1.2rem;
            color: var(--primary-accent);
        }
        
        /* Specific card styling */
        .clusters-card:hover {
            border-color: var(--primary-accent);
        }
        
        .hives-card:hover {
            border-color: var(--success);
        }
        
        .actions-card:hover {
            border-color: var(--info);
        }
        
        .flagged-card:hover {
            border-color: var(--warning);
        }
        
        /* Static number display */
        .stat-number {
            opacity: 1;
        }
        
        /* Action Items */
        .action-item {
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            margin-bottom: var(--spacing-sm);
            background: var(--primary-bg);
            border-left: 4px solid var(--primary-accent);
        }
        
        .action-item:hover {
            background: var(--secondary-accent);
        }
        
        .action-item.flag-urgent {
            border-left-color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .action-item.flag-warning {
            border-left-color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }
        
        .action-item.flag-info {
            border-left-color: var(--info);
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* Map */
        #map {
            height: 100%;
            min-height: 450px;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            background: #f8f9fa;
        }
        
        /* Map loading improvements */
        .leaflet-container {
            background: #f8f9fa !important;
        }
        
        .leaflet-tile {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }
        
        /* Cluster popup styling */
        .cluster-popup {
            min-width: 200px;
        }
        
        .cluster-popup h6 {
            margin-bottom: 0.5rem;
            color: var(--dark-yellow);
        }
        
        .cluster-popup p {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }
        
        /* Enhanced Calendar Widget */
        .calendar-widget {
            background: var(--primary-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            max-height: 600px;
            overflow-y: auto;
        }
        
        .calendar-summary {
            background: linear-gradient(135deg, var(--secondary-accent) 0%, rgba(31, 200, 222, 0.1) 100%);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            border: 1px solid rgba(31, 200, 222, 0.2);
        }
        
        .summary-item {
            padding: var(--spacing-sm);
        }
        
        /* Weather Widget */
        .weather-content {
            padding: var(--spacing-sm);
        }
        
        .weather-header h6 {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .weather-days {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        .weather-day {
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.5);
        }
        
        .weather-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
        }
        
        .weather-day-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .weather-icon {
            flex-shrink: 0;
        }
        
        .weather-details {
            flex: 1;
        }
        
        .weather-temp {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .weather-desc {
            text-transform: capitalize;
        }
        
        .weather-extra {
            display: flex;
            gap: var(--spacing-sm);
            opacity: 0.7;
        }
        
        .weather-extra i {
            margin-right: 0.25rem;
        }
        
        .weather-update-time {
            font-size: 0.85rem;
        }
        
        .weather-placeholder {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-secondary);
        }
        
        .weather-placeholder i {
            font-size: 3rem;
            margin-bottom: var(--spacing-sm);
        }
        
        .summary-item strong {
            font-size: 1.5rem;
            display: block;
        }
        
        .calendar-date {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background: var(--secondary-accent);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .calendar-date:hover {
            background: rgba(31, 200, 222, 0.05);
            border-color: rgba(31, 200, 222, 0.2);
        }
        
        .calendar-date.today {
            background: rgba(31, 200, 222, 0.15);
            border-left: 4px solid var(--primary-accent);
            box-shadow: 0 2px 8px rgba(31, 200, 222, 0.2);
        }
        
        .calendar-date.tomorrow {
            background: rgba(52, 152, 219, 0.15);
            border-left: 4px solid var(--info);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }
        
        .calendar-date.this-week {
            background: rgba(39, 174, 96, 0.1);
            border-left: 4px solid var(--success);
        }
        
        .calendar-date-header {
            margin-bottom: var(--spacing-sm);
        }
        
        .date-badges .badge {
            font-size: 0.7rem;
            margin-left: var(--spacing-xs);
        }
        
        .calendar-task {
            background: var(--primary-bg);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-xs);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .calendar-task:hover {
            background: rgba(31, 200, 222, 0.05);
            border-color: rgba(31, 200, 222, 0.3);
            transform: translateX(4px);
        }
        
        .calendar-task.overdue {
            background: rgba(231, 76, 60, 0.1);
            border-left: 3px solid var(--danger);
        }
        
        .calendar-task.overdue:hover {
            background: rgba(231, 76, 60, 0.15);
        }
        
        .task-header {
            display: flex;
            justify-content: between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }
        
        .task-name {
            flex-grow: 1;
            font-size: 0.9rem;
            line-height: 1.3;
        }
        
        .task-details {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .task-details i {
            margin-right: 0.25rem;
        }
        
        .task-actions {
            margin-left: var(--spacing-sm);
        }
        
        .task-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        /* Reports Styling */
        
        /* Timeline */
        .timeline-container {
            background: var(--primary-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .timeline-date {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            background: var(--secondary-accent);
        }
        
        .timeline-date.today {
            background: rgba(31, 200, 222, 0.1);
            border-left: 4px solid var(--primary-accent);
        }
        
        .timeline-date.past {
            opacity: 0.7;
        }
        
        .timeline-task {
            background: var(--primary-bg);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            margin-bottom: var(--spacing-xs);
        }
        
        .timeline-task.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        
        /* Cluster Cards */
        .cluster-card {
            transition: all 0.3s ease;
        }
        
        .cluster-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Custom Cluster Markers */
        .custom-cluster-marker {
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }
        
        /* Map Popup Styling */
        .cluster-popup .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        
        .cluster-popup .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
        }
        
        .cluster-popup a {
            transition: all 0.3s ease;
        }
        
        .cluster-popup a:hover {
            text-decoration: underline !important;
            transform: scale(1.05);
        }
        
        .cluster-popup .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
        }
        
        /* Sync Status */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--dark-yellow);
            border-radius: 20px;
            padding: 8px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            font-size: 0.85rem;
            backdrop-filter: blur(8px);
            opacity: 0.9;
        }
        
        /* Mobile sync indicator positioning */
        @media (max-width: 768px) {
            .sync-indicator {
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                bottom: auto;
                right: auto;
                width: auto;
                min-width: 200px;
                text-align: center;
                z-index: 1030;
            }
            
            /* Ensure sync indicator doesn't overlap with navbar */
            .sync-indicator.syncing,
            .sync-indicator.error {
                top: 90px;
            }
        }
        
        .sync-indicator.syncing {
            background: rgba(255, 193, 7, 0.15);
            border-color: var(--accent);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .sync-indicator.error {
            background: rgba(220, 53, 69, 0.15);
            border-color: #DC3545;
        }
        
        @keyframes pulse {
            0% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.9; transform: scale(1); }
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }
            
            .card {
                margin-bottom: var(--spacing-md);
            }
            
            #map {
                height: 300px;
            }
            
            /* Mobile dashboard cards - 4 column grid */
            .dashboard-stat-card .card-body {
                padding: 1rem 0.75rem;
            }
            
            .stat-icon-container i {
                font-size: 2rem;
            }
            
            .stat-number {
                font-size: 1.75rem;
            }
            
            .stat-label {
                font-size: 0.8rem;
            }
            
            .stat-action-indicator {
                top: 0.75rem;
                right: 0.75rem;
            }
            
            /* Mobile calendar widget */
            .calendar-widget {
                max-height: 400px;
                padding: 1rem;
            }
            
            .calendar-summary {
                padding: 0.75rem;
            }
            
            .summary-item strong {
                font-size: 1.2rem;
            }
            
            .calendar-date {
                padding: 0.75rem;
            }
            
            .calendar-task {
                padding: 0.5rem;
            }
            
            .task-name {
                font-size: 0.8rem;
            }
            
            .task-details {
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-stat-card .card-body {
                padding: 0.75rem 0.5rem;
            }
            
            .stat-icon-container i {
                font-size: 1.5rem;
            }
            
            .stat-number {
                font-size: 1.5rem;
            }
            
            .stat-label {
                font-size: 0.7rem;
            }
        }
        
        /* Accessibility improvements */
        .dashboard-stat-card:focus {
            outline: 3px solid var(--primary-accent);
            outline-offset: 2px;
        }
        
        .dashboard-stat-card:focus:not(:focus-visible) {
            outline: none;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .dashboard-stat-card {
                border: 2px solid var(--text-primary);
            }
            
            .stat-number {
                color: var(--text-primary) !important;
                -webkit-text-fill-color: var(--text-primary) !important;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .dashboard-stat-card,
            .stat-icon-container i,
            .stat-number,
            .stat-label,
            .stat-action-indicator {
                transition: none;
            }
            
            .stat-number {
                animation: none;
            }
        }
        
        /* Hidden class */
        .hidden {
            display: none !important;
        }
        
        /* Employee hidden */
        .employee-hidden {
            display: none !important;
        }
        
        /* Calendar Styles */
        .fc {
            font-family: inherit;
        }
        
        .fc-event {
            border-radius: 4px;
            border: none;
            padding: 2px 4px;
            font-size: 0.85rem;
        }
        
        .fc-event.priority-urgent {
            background-color: #dc3545;
            color: white;
        }
        
        .fc-event.priority-high {
            background-color: #ffc107;
            color: #212529;
        }
        
        .fc-event.priority-normal {
            background-color: #17a2b8;
            color: white;
        }
        
        .fc-event.overdue {
            background-color: #6c757d;
            color: white;
            text-decoration: line-through;
        }
        
        .fc-toolbar {
            margin-bottom: 1rem;
        }
        
        .fc-button {
            background-color: var(--primary-accent);
            border-color: var(--primary-accent);
        }
        
        .fc-button:hover {
            background-color: #17a2b8;
            border-color: #17a2b8;
        }
        
        .fc-button:focus {
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }
        
        /* Admin badge */
        .admin-badge {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            font-weight: 600;
        }
        
        /* Hexagon Button for Welcome Modal */
        .hexagon-button {
            position: relative;
            width: 120px;
            height: 60px;
            background: #28a745;
            border: none;
            border-radius: 0;
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
            transition: all 0.3s ease;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hexagon-button:hover {
            background: #218838;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .hexagon-button:active {
            transform: scale(0.95);
        }
        
        .hexagon-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .hexagon-text {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: lowercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Sync Status Indicator -->
    <div id="syncIndicator" class="sync-indicator hidden">
        <span id="syncText"></span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="container-fluid vh-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #8B4513 0%, #A0522D 25%, #CD853F 50%, #D2691E 75%, #8B4513 100%);">
        <div class="row w-100">
            <div class="col-md-6 col-lg-4 mx-auto">
                <div class="card shadow-lg" style="background: var(--glass); backdrop-filter: blur(12px) saturate(1.1); border: 1px solid rgba(255,255,255,0.2);">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <i class="bi bi-hexagon-fill" style="font-size: 4rem; color: var(--accent);"></i>
                            <h2 class="mt-3" style="color: var(--brand);">BeeMarshall</h2>
                            <p class="text-muted">Professional Apiary Management System</p>
                            <div class="alert alert-info border-0" style="background: rgba(13, 202, 240, 0.1); margin-top: 1rem;">
                                <small>
                                    <strong>Beekeeper Workflow:</strong> Dashboard → Clusters → Actions → Schedule → Team<br>
                                    <em>Each section supports your complete apiary management workflow</em>
                                </small>
                            </div>
                            <div class="version-tag">
                                <span class="badge bg-primary" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">
                                    <i class="bi bi-tag-fill me-1"></i>v0.98
                                </span>
                            </div>
                        </div>
                        
                        <!-- Login Status Messages -->
                        <div id="loginStatus" class="alert alert-info d-none" role="alert">
                            <i class="bi bi-info-circle"></i>
                            <span id="loginStatusText">Checking system status...</span>
                        </div>
                        
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label fw-semibold">Username</label>
                                <input type="text" class="form-control" id="loginUsername" required 
                                       placeholder="Enter your username" autocomplete="username">
                            </div>
                            <div class="mb-3">
                                <label for="loginPassword" class="form-label fw-semibold">Password</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="loginPassword" required 
                                           placeholder="Enter your password" autocomplete="current-password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                        <i id="passwordToggleIcon" class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-2" id="loginButton">
                                <span id="loginButtonText">Login</span>
                                <span id="loginSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
                            </button>
                            
                        </form>
                        
                        <div class="mt-4">
                            <div class="text-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Available accounts: GBTech (master), Lars (admin), Demo (demo)
                                </small>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-tag"></i> Version v0.98
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Legal Declarations -->
                            <div class="mt-4 p-3" style="background: rgba(255,255,255,0.1); border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);">
                                <div class="text-center mb-3">
                                    <small class="text-muted fw-bold">Legal & Privacy Information</small>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <strong>Terms of Use:</strong> By using BeeMarshall, you agree to our terms of service. 
                                                This system is designed for professional apiary management and data security.
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                <strong>Data Privacy:</strong> Your data is stored securely in Firebase cloud infrastructure. 
                                                While encrypted in transit and at rest, data is not entirely hidden from advanced analysis.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-2">
                                    <small class="text-muted">
                                        <strong>Open Source:</strong> BeeMarshall is built on open-source technologies. 
                                        Source code and data structures are transparent and auditable.
                                    </small>
                                </div>
                            </div>
                            
                            <!-- Debug Panel (hidden in production) -->
                            <div class="mt-3" id="debugSection" style="display: none;">
                                <button class="btn btn-sm btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#debugPanel">
                                    <i class="bi bi-bug"></i> Debug Information
                                </button>
                                <div class="collapse mt-2" id="debugPanel">
                                    <div class="card card-body bg-light">
                                        <small>
                                            <strong>System Status:</strong> <span id="systemStatus">Checking...</span><br>
                                            <strong>Firebase:</strong> <span id="firebaseStatus">Connecting...</span><br>
                                            <strong>Last Error:</strong> <span id="lastError">None</span><br>
                                            <strong>Session:</strong> <span id="sessionInfo">Not logged in</span><br>
                                            <strong>Version:</strong> <span id="versionInfo">v0.98</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
            <div class="container-fluid">
                <!-- Logo/Brand -->
                <a class="navbar-brand" href="#" onclick="showDashboard()">
                    <i class="bi bi-hexagon-fill"></i> BeeMarshall
                </a>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Primary Navigation -->
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showDashboard()">
                                <i class="bi bi-house"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showClusters()">
                                <i class="bi bi-geo-alt"></i> Sites
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showActions()">
                                <i class="bi bi-list-check"></i> Actions
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showScheduledTasks()">
                                <i class="bi bi-calendar3"></i> Schedule
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" onclick="showTasks()">
                                <i class="bi bi-list-task"></i> Tasks
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="reports.html" target="_blank">
                                <i class="bi bi-graph-up"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showComplianceView()">
                                <i class="bi bi-shield-check"></i> Compliance
                            </a>
                        </li>
                        <li class="nav-item admin-only">
                            <a class="nav-link" href="#" onclick="showEmployees()">
                                <i class="bi bi-people"></i> Team
                            </a>
                        </li>
                    </ul>
                    
                    <!-- Right Side Navigation -->
                    <ul class="navbar-nav ms-auto align-items-center">
                        <!-- Help/Documentation -->
                        <li class="nav-item">
                            <a class="nav-link" href="#" onclick="showHelpModal()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Help & Documentation">
                                <i class="bi bi-question-circle"></i>
                                <span class="d-none d-md-inline ms-1">Help</span>
                            </a>
                        </li>
                        
                        <!-- User Profile Dropdown -->
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle"></i>
                                <span class="d-none d-md-inline ms-1">
                                    <span id="currentUserDisplay"></span>
                                    <span id="adminBadge" class="badge admin-badge ms-2 hidden">ADMIN</span>
                                </span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showSettingsModal()">
                                        <i class="bi bi-gear"></i> Settings
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="showProfileModal()">
                                        <i class="bi bi-person"></i> Profile
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="bi bi-box-arrow-right"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        </li>
                        
                        <!-- Sync Status -->
                        <li class="nav-item">
                            <span id="syncStatus" class="navbar-text me-3">
                                <i class="bi bi-wifi text-warning"></i> Online
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid mt-4">
            <!-- Dashboard View -->
            <div id="dashboardView">
                <!-- Dashboard Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h1 class="h3 mb-1">Dashboard Overview</h1>
                                <p class="text-muted mb-0">Monitor your apiary operations and key metrics</p>
                            </div>
                            <div>
                                <button class="btn btn-warning me-2" onclick="forceMigrateLarsData()" id="migrationButton" style="display: none;">
                                    <i class="bi bi-arrow-repeat"></i> Migrate Lars Data
                                </button>
                                <button class="btn btn-primary" onclick="showScheduleTaskModal()">
                                    <i class="bi bi-plus"></i> Quick Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Metrics Row - 4 Column Grid -->
                <div class="row g-2 mb-4">
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card clusters-card" onclick="showClusters()" data-target="clusters">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-geo-alt-fill text-primary"></i>
                                </div>
                                <h3 id="statClusters" class="stat-number">0</h3>
                                <p class="stat-label">Total Sites</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card hives-card" onclick="showClusters()" data-target="clusters">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-hexagon-fill text-warning"></i>
                                </div>
                                <h3 id="statHives" class="stat-number">0</h3>
                                <p class="stat-label">Total Hives</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card actions-card" onclick="showActions()" data-target="actions">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-list-check text-info"></i>
                                </div>
                                <h3 id="statActions" class="stat-number">0</h3>
                                <p class="stat-label">Total Actions</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-sm-3 mb-2">
                        <div class="card dashboard-stat-card flagged-card" onclick="showFlagged()" data-target="flagged">
                            <div class="card-body text-center position-relative">
                                <div class="stat-icon-container">
                                    <i class="bi bi-flag-fill text-warning"></i>
                                </div>
                                <h3 id="statFlagged" class="stat-number">0</h3>
                                <p class="stat-label">Flagged Issues</p>
                                <div class="stat-action-indicator">
                                    <i class="bi bi-arrow-right-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Row -->
                <div class="row">
                    <!-- Map Section - Desktop Grid Layout -->
                    <div class="col-lg-12 mb-4">
                        <div class="row g-3">
                            <!-- Map on Left -->
                            <div class="col-lg-7">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="bi bi-map"></i> Site Locations</h5>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary" onclick="showClusters()">
                                                <i class="bi bi-geo-alt"></i> Manage Sites
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-0" style="min-height: 450px;">
                                        <!-- Map Placeholder (Grayed Out) -->
                                        <div id="mapPlaceholder" class="map-placeholder" onclick="activateMap()">
                                            <div class="map-placeholder-content">
                                                <i class="bi bi-map" style="font-size: 3rem; color: #6c757d;"></i>
                                                <h6 class="mt-3 text-muted">Click to Load Map</h6>
                                                <p class="text-muted small">Interactive map will load when you click here</p>
                                                <button class="btn btn-outline-primary btn-sm mt-2">
                                                    <i class="bi bi-play-circle me-1"></i>Initialize Map
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Actual Map (Hidden Initially) -->
                                        <div id="map" style="height: 100%; min-height: 350px; display: none;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upcoming Tasks and Quick Stats on Right -->
                            <div class="col-lg-5">
                                <div class="row g-3 h-100">
                                    <!-- Calendar Widget -->
                                    <div class="col-12">
                                        <div class="card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Upcoming Tasks</h5>
                                                <button class="btn btn-sm btn-outline-primary" onclick="showScheduledTasks()">
                                                    <i class="bi bi-calendar3"></i> View All
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <div id="calendarWidget">
                                                    <p class="text-muted">Loading calendar...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Row -->
                <div class="row">
                    <!-- Recent Actions with Quick Stats -->
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Actions</h5>
                                <button class="btn btn-sm btn-outline-primary" onclick="showActions()">
                                    <i class="bi bi-list-check"></i> View All
                                </button>
                            </div>
                            <div class="card-body">
                                <!-- Quick Stats Section (Nested inside Recent Actions) -->
                                <div class="card bg-light mb-3">
                                    <div class="card-body py-2">
                                        <div class="row text-center g-2">
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-primary mb-0" id="statThisWeek">0</h6>
                                                    <small class="text-muted">This Week</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-success mb-0" id="statCompleted">0</h6>
                                                    <small class="text-muted">Completed</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-warning mb-0" id="statPending">0</h6>
                                                    <small class="text-muted">Pending</small>
                                                </div>
                                            </div>
                                            <div class="col-3">
                                                <div class="quick-stat">
                                                    <h6 class="text-danger mb-0" id="statOverdue">0</h6>
                                                    <small class="text-muted">Overdue</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Recent Actions List -->
                                <div id="recentActions">
                                    <p class="text-muted">Loading actions...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Flagged Items Alert -->
                <div id="flaggedAlert" class="alert alert-warning hidden">
                    <h6><i class="bi bi-exclamation-triangle"></i> Urgent Items Require Attention</h6>
                    <div id="flaggedItemsList"></div>
                </div>
            </div>

            <!-- Clusters View -->
            <div id="clustersView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-geo-alt"></i> Apiary Sites</h2>
                    <div>
                        <button class="btn btn-outline-success me-2" onclick="exportClustersCSV()">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="showAddClusterForm()">
                            <i class="bi bi-plus"></i> Add Site
                        </button>
                    </div>
                </div>
                
                <div id="clusterTypeFilter" class="mb-4"></div>
                
                <div class="row" id="clustersList">
                    <div class="text-center my-5">
                        <i class="bi bi-geo-alt" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">No sites yet</h5>
                        <p class="text-muted">Get started by adding your first apiary location</p>
                        <button class="btn btn-primary" onclick="showAddClusterForm()">
                            <i class="bi bi-plus"></i> Add Your First Site
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cluster Form View -->
            <div id="clusterFormView" class="hidden">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5 id="clusterFormTitle">Add New Hive Cluster</h5>
                            </div>
                            <div class="card-body">
                                <form id="clusterForm">
                                    <input type="hidden" id="clusterId">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="clusterName" class="form-label">Cluster Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="clusterName" required placeholder="e.g., Main Apiary, North Field">
                                            <div class="form-text">Give your apiary location a descriptive name</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="clusterType" class="form-label">Site Type <span class="text-danger">*</span></label>
                                            <select class="form-select" id="clusterType" required>
                                                <option value="">Select site type...</option>
                                                <option value="production">Production</option>
                                                <option value="nucleus">NUC (Nucleus)</option>
                                                <option value="queen-rearing">Queen Rearing</option>
                                                <option value="research">Research</option>
                                                <option value="education">Education</option>
                                                <option value="quarantine">Quarantine</option>
                                                <option value="backup">Backup</option>
                                                <option value="custom">Custom</option>
                                            </select>
                                            <div class="form-text">Choose the primary purpose of this apiary location</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="clusterDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="clusterDescription" rows="3"></textarea>
                                    </div>
                                    
                                    <!-- Hive Box Site Report -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-grid"></i> Hive Box Site Report</h6>
                                            <small class="text-muted">Click boxes to update site inventory. Changes are automatically saved as actions.</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-12">
                                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="renderVisualHiveGrid()">
                                                        <i class="bi bi-arrow-clockwise"></i> Refresh Grid
                                                    </button>
                                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="saveVisualHiveChanges()">
                                                        <i class="bi bi-check-circle"></i> Save & Log Site Visit
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="visualHiveGrid" class="mb-3">
                                                <p class="text-muted text-center">Loading visual hive grid...</p>
                                            </div>
                                            <div class="alert alert-info mt-3">
                                                <small><i class="bi bi-info-circle"></i> <strong>Site Report:</strong> Click on any hive box to update its status. All changes will be logged as actions automatically when you save.</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label for="clusterLat" class="form-label">Latitude <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="clusterLat" step="0.000001" min="-90" max="90" placeholder="-40.6764" required>
                                            <div class="form-text">Enter latitude (e.g., -40.6764 for Collingwood, NZ)</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="clusterLng" class="form-label">Longitude <span class="text-danger">*</span></label>
                                            <input type="number" class="form-control" id="clusterLng" step="0.000001" min="-180" max="180" placeholder="172.6856" required>
                                            <div class="form-text">Enter longitude (e.g., 172.6856 for Collingwood, NZ)</div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="clusterHiveCount" class="form-label">Total Hive Count *</label>
                                            <input type="number" class="form-control" id="clusterHiveCount" min="1" required onchange="updateHiveStrengthTotals()">
                                            <div class="form-text">Total number of hives in this site</div>
                                        </div>
                                    </div>
                                    
                                    <!-- GPS and Map Selection Options -->
                                    <div class="mb-3">
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary" id="useLocationBtn">
                                                <i class="bi bi-crosshair"></i> Use Current GPS Location
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="showMapPicker()">
                                                <i class="bi bi-map"></i> Click on Map to Select
                                            </button>
                                        </div>
                                        <div class="form-text text-muted mt-2">
                                            <i class="bi bi-info-circle"></i> Use GPS to auto-fill your current location, or click the map to pick a location interactively
                                        </div>
                                    </div>
                                    
                                    <!-- Hive Strength Breakdown -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h6 class="mb-0"><i class="bi bi-hexagon-fill"></i> Hive Strength Distribution</h6>
                                            <small class="text-muted">Break down your hives by strength rating</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="hiveStrong" class="form-label">Strong Hives</label>
                                                    <input type="number" class="form-control" id="hiveStrong" min="0" value="0" onchange="updateHiveStrengthTotals()">
                                                    <div class="form-text">Healthy, productive hives</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="hiveMedium" class="form-label">Medium Hives</label>
                                                    <input type="number" class="form-control" id="hiveMedium" min="0" value="0" onchange="updateHiveStrengthTotals()">
                                                    <div class="form-text">Average health and production</div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="hiveWeak" class="form-label">Weak Hives</label>
                                                    <input type="number" class="form-control" id="hiveWeak" min="0" value="0" onchange="updateHiveStrengthTotals()">
                                                    <div class="form-text">Struggling, need attention</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="hiveNUC" class="form-label">NUC Hives</label>
                                                    <input type="number" class="form-control" id="hiveNUC" min="0" value="0" onchange="updateHiveStrengthTotals()">
                                                    <div class="form-text">Nucleus colonies</div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="hiveDead" class="form-label">Dead Hives</label>
                                                    <input type="number" class="form-control" id="hiveDead" min="0" value="0" onchange="updateHiveStrengthTotals()">
                                                    <div class="form-text">Failed or dead colonies</div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="alert alert-info">
                                                        <strong>Total Breakdown:</strong> <span id="hiveStrengthTotal">0</span> hives
                                                        <br><small id="hiveStrengthStatus" class="text-muted">Enter hive counts above</small>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Detailed Hive Breakdown Summary -->
                                            <div class="row mt-3" id="hiveBreakdownSummary" style="display: none;">
                                                <div class="col-12">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Detailed Hive Breakdown</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-success">Strong Hives</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-success" role="progressbar" id="strongProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Healthy, productive colonies</small>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6 class="text-warning">Medium Hives</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-warning" role="progressbar" id="mediumProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Average health and production</small>
                                                                </div>
                                                            </div>
                                                            <div class="row mt-3">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-danger">Weak Hives</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-danger" role="progressbar" id="weakProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Struggling, need attention</small>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6 class="text-info">NUC Hives</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-info" role="progressbar" id="nucProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Nucleus colonies</small>
                                                                </div>
                                                            </div>
                                                            <div class="row mt-3">
                                                                <div class="col-md-6">
                                                                    <h6 class="text-dark">Dead Hives</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-dark" role="progressbar" id="deadProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Failed or dead colonies</small>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <h6 class="text-secondary">Empty Platforms</h6>
                                                                    <div class="progress mb-2" style="height: 20px;">
                                                                        <div class="progress-bar bg-secondary" role="progressbar" id="emptyProgress" style="width: 0%"></div>
                                                                    </div>
                                                                    <small class="text-muted">Unused hive platforms</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Stack Configuration Summary -->
                                            <div class="row mt-3" id="stackBreakdownSummary" style="display: none;">
                                                <div class="col-12">
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="mb-0"><i class="bi bi-stack"></i> Stack Configuration Summary</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row">
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-primary" id="doublesCount">0</h5>
                                                                        <small class="text-muted">Double Stacks</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-success" id="topSplitsCount">0</h5>
                                                                        <small class="text-muted">Top-Splits</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <div class="text-center">
                                                                        <h5 class="text-warning" id="singlesCount">0</h5>
                                                                        <small class="text-muted">Single Stacks</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="row mt-3">
                                                                <div class="col-md-6">
                                                                    <div class="text-center">
                                                                        <h5 class="text-info" id="nucsCount">0</h5>
                                                                        <small class="text-muted">NUC Stacks</small>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="text-center">
                                                                        <h5 class="text-secondary" id="emptyStacksCount">0</h5>
                                                                        <small class="text-muted">Empty Platforms</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Site Classification -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-geo"></i> Site Classification</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="siteType" class="form-label">Site Type</label>
                                                    <select class="form-select" id="siteType">
                                                        <option value="">Select site type...</option>
                                                        <option value="summer">Summer Site</option>
                                                        <option value="winter">Winter Site</option>
                                                        <option value="year-round">Year-round Site</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="accessType" class="form-label">Access Type</label>
                                                    <select class="form-select" id="accessType">
                                                        <option value="">Select access type...</option>
                                                        <option value="all-weather">All Weather</option>
                                                        <option value="dry-only">Dry Only</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="contactBeforeVisit">
                                                        <label class="form-check-label" for="contactBeforeVisit">
                                                            Contact Landowner Before Visit
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="isQuarantine">
                                                        <label class="form-check-label" for="isQuarantine">
                                                            Quarantine Site
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Landowner Information -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-person"></i> Landowner Information</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerName" class="form-label">Name</label>
                                                    <input type="text" class="form-control" id="landownerName">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerPhone" class="form-label">Phone</label>
                                                    <input type="tel" class="form-control" id="landownerPhone">
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerEmail" class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="landownerEmail">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="landownerAddress" class="form-label">Address</label>
                                                    <input type="text" class="form-control" id="landownerAddress">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="clusterHarvest" class="form-label">Expected Harvest Date</label>
                                            <input type="date" class="form-control" id="clusterHarvest">
                                            <div class="form-text">Date when honey harvest is expected</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="clusterSugar" class="form-label">Sugar Requirements</label>
                                            <input type="text" class="form-control" id="clusterSugar" placeholder="e.g., 20kg for winter">
                                        </div>
                                    </div>
                                    
                                    <!-- Historical Harvest Records -->
                                    <div class="card mb-3">
                                        <div class="card-header">
                                            <h6><i class="bi bi-archive"></i> Historical Harvest Records</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="harvestRecordsContainer">
                                                <p class="text-muted small">No harvest records yet. Add your first harvest below.</p>
                                            </div>
                                            <hr>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label for="harvestDate" class="form-label">Harvest Date</label>
                                                    <input type="date" class="form-control" id="harvestDate">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="harvestQuantity" class="form-label">Quantity (kg)</label>
                                                    <input type="number" step="0.1" class="form-control" id="harvestQuantity" placeholder="e.g., 25.5">
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="harvestNotes" class="form-label">Notes</label>
                                                    <input type="text" class="form-control" id="harvestNotes" placeholder="e.g., Late harvest due to weather">
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-outline-success btn-sm mt-2" onclick="addHarvestRecord()">
                                                <i class="bi bi-plus"></i> Add Harvest Record
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="clusterNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="clusterNotes" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check"></i> Save Cluster
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showClusters()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Map Picker -->
                <div id="mapPickerContainer" class="hidden mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h6><i class="bi bi-map"></i> Pick Location on Map</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="mapPicker" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions View -->
            <div id="actionsView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-list-check"></i> Actions</h2>
                    <div>
                        <button class="btn btn-outline-success me-2" onclick="exportActionsCSV()">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="showLogActionForm()">
                            <i class="bi bi-plus"></i> Log Action
                        </button>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <select class="form-select" id="filterCluster">
                            <option value="">All Clusters</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterCategory">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterEmployee">
                            <option value="">All Employees</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="renderActions()">
                            <i class="bi bi-funnel"></i> Apply Filters
                        </button>
                    </div>
                </div>
                
                <div id="actionsList">
                    <div class="text-center my-5">
                        <i class="bi bi-list-check" style="font-size: 3rem; color: #ccc;"></i>
                        <h5 class="mt-3 text-muted">No actions logged yet</h5>
                        <p class="text-muted">Start by logging your first inspection or treatment</p>
                        <button class="btn btn-primary" onclick="showAddActionForm()">
                            <i class="bi bi-plus"></i> Log Your First Action
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Action Form View -->
            <div id="logActionView" class="hidden">
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-plus-circle"></i> Log New Action</h5>
                            </div>
                            <div class="card-body">
                                <form id="actionForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="actionCluster" class="form-label">Cluster *</label>
                                            <select class="form-select" id="actionCluster" required onchange="loadClusterHives()">
                                                <option value="">Select cluster...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="actionDate" class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="actionDate" required>
                                        </div>
                                    </div>
                                    
                                    <div id="individualHiveSelect" class="mb-3 hidden">
                                        <label for="actionHive" class="form-label">Specific Hive (Optional)</label>
                                        <select class="form-select" id="actionHive">
                                            <option value="">All hives in cluster</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Tasks Performed *</label>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterTaskCheckboxes('common')">
                                                <i class="bi bi-star"></i> Common Tasks
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterTaskCheckboxes('all')">
                                                <i class="bi bi-list"></i> All Tasks
                                            </button>
                                        </div>
                                        <div id="taskCheckboxes"></div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="actionFlag" class="form-label">Flag</label>
                                            <select class="form-select" id="actionFlag">
                                                <option value="">No flag</option>
                                                <option value="info">Info</option>
                                                <option value="warning">Warning</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="actionNotes" class="form-label">Notes</label>
                                        <textarea class="form-control" id="actionNotes" rows="3"></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check"></i> Log Action
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showActions()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduled Tasks View -->
            <div id="scheduledView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-calendar3"></i> Scheduled Tasks</h2>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="toggleCalendarView()" id="calendarToggleBtn">
                            <i class="bi bi-calendar3"></i> Calendar View
                        </button>
                        <button class="btn btn-primary" onclick="showScheduleForNextVisit()">
                            <i class="bi bi-calendar-plus"></i> Schedule New Task
                        </button>
                        <button class="btn btn-outline-success ms-2" onclick="generateCalendarFeed()">
                            <i class="bi bi-download"></i> Export Calendar
                        </button>
                        <button class="btn btn-outline-primary ms-2" onclick="copyCalendarFeedLink()">
                            <i class="bi bi-link-45deg"></i> Copy Feed Link
                        </button>
                        <button class="btn btn-outline-info ms-2" onclick="showCalendarSubscriptionInstructions()">
                            <i class="bi bi-calendar-plus"></i> Subscribe to Calendar
                        </button>
                    </div>
                </div>
                
                <!-- Calendar View -->
                <div id="calendarView" class="hidden mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar3"></i> Task Calendar</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="exportToGoogleCalendar()">
                                    <i class="bi bi-google"></i> Export to Google Calendar
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="copyCalendarFeedLink()">
                                    <i class="bi bi-link-45deg"></i> Copy Calendar Feed
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="taskCalendar"></div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-list-check"></i> Scheduled Tasks</h5>
                            </div>
                            <div class="card-body">
                                <div id="scheduledTasksList">
                                    <p class="text-muted">Loading scheduled tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-timeline"></i> Timeline</h5>
                            </div>
                            <div class="card-body">
                                <div id="scheduleTimeline">
                                    <p class="text-muted">Loading timeline...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule for Next Visit View -->
            <div id="scheduleForNextVisitView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-calendar-plus"></i> Schedule for Next Visit</h2>
                    <button class="btn btn-secondary" onclick="showScheduledTasks()">
                        <i class="bi bi-arrow-left"></i> Back to Schedule
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-geo-alt"></i> Add tasks to do on next visit to this cluster:</h5>
                            </div>
                            <div class="card-body">
                                <form id="nextVisitForm">
                                    <div class="mb-3">
                                        <label for="nextVisitCluster" class="form-label">Select Cluster *</label>
                                        <select class="form-select" id="nextVisitCluster" required onchange="loadNextVisitTasks()">
                                            <option value="">Choose cluster...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">Tasks to Schedule for Next Visit *</label>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterNextVisitTasks('common')">
                                                <i class="bi bi-star"></i> Common Tasks
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="filterNextVisitTasks('all')">
                                                <i class="bi bi-list"></i> All Tasks
                                            </button>
                                        </div>
                                        <div id="nextVisitTaskCheckboxes"></div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="nextVisitDate" class="form-label">Planned Visit Date *</label>
                                            <input type="date" class="form-control" id="nextVisitDate" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="nextVisitTime" class="form-label">Planned Visit Time (Optional)</label>
                                            <input type="time" class="form-control" id="nextVisitTime">
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="nextVisitPriority" class="form-label">Priority</label>
                                        <select class="form-select" id="nextVisitPriority">
                                            <option value="normal">Normal</option>
                                            <option value="high">High</option>
                                            <option value="urgent">Urgent</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="nextVisitNotes" class="form-label">Notes for Next Visit</label>
                                        <textarea class="form-control" id="nextVisitNotes" rows="3" placeholder="Any specific instructions or notes for the next visit..."></textarea>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-success">
                                            <i class="bi bi-calendar-plus"></i> Schedule Tasks for Next Visit
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="showScheduledTasks()">
                                            <i class="bi bi-x"></i> Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suggested Schedule View -->
            <div id="suggestedScheduleView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-lightbulb"></i> Suggested Schedule</h2>
                    <button class="btn btn-secondary" onclick="showScheduledTasks()">
                        <i class="bi bi-arrow-left"></i> Back to Schedule
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar-heart"></i> Seasonal Task Suggestions</h5>
                    </div>
                    <div class="card-body">
                        <div id="suggestedTasksList">
                            <p class="text-muted">Loading suggestions...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Task Management View -->
            <div id="tasksView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-list-task"></i> Task Management</h2>
                    <button class="btn btn-primary" onclick="showAddTaskForm()">
                        <i class="bi bi-plus-circle"></i> Add New Task
                    </button>
                </div>
                
                <!-- Task Categories -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Task Categories</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-primary w-100" onclick="filterTasksByCategory('Inspection')">
                                            <i class="bi bi-search"></i> Inspection
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-success w-100" onclick="filterTasksByCategory('Management')">
                                            <i class="bi bi-gear"></i> Management
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-warning w-100" onclick="filterTasksByCategory('Health')">
                                            <i class="bi bi-heart-pulse"></i> Health
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <button class="btn btn-outline-info w-100" onclick="filterTasksByCategory('All')">
                                            <i class="bi bi-list"></i> All Tasks
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Task List -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Available Tasks</h5>
                            </div>
                            <div class="card-body">
                                <div id="tasksList">
                                    <p class="text-center text-muted my-5">Loading tasks...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Flagged Items View -->
            <div id="flaggedView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-flag"></i> Flagged Items</h2>
                </div>
                
                <div id="flaggedItemsList2">
                    <p class="text-center text-muted my-5">Loading flagged items...</p>
                </div>
            </div>

            <!-- Employee Management View -->
            <div id="employeesView" class="hidden">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-people"></i> Team Management</h2>
                </div>
                
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-person-plus"></i> Add Employee</h5>
                            </div>
                            <div class="card-body">
                                <form id="addEmployeeForm">
                                    <div class="mb-3">
                                        <label for="newEmployeeName" class="form-label">Employee Name</label>
                                        <input type="text" class="form-control" id="newEmployeeName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="newEmployeePassword" class="form-label">Password</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="newEmployeePassword" required>
                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleEmployeePasswordVisibility()">
                                                <i id="employeePasswordToggleIcon" class="bi bi-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus"></i> Add Employee
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="bi bi-people-fill"></i> Current Team</h5>
                            </div>
                            <div class="card-body">
                                <div id="employeesList">
                                    <p class="text-muted">Loading employees...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Management View -->
            <div id="complianceView" class="hidden">
                <div id="complianceDashboard">
                    <!-- Compliance content will be rendered here -->
                </div>
            </div>

        </div>

        <!-- Schedule Task Modal -->
        <div class="modal fade" id="scheduleTaskModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Schedule New Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="scheduleTaskForm">
                            <div class="mb-3">
                                <label for="scheduleCluster" class="form-label">Site *</label>
                                <select class="form-select" id="scheduleCluster" required>
                                    <option value="">Select site...</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="scheduleTask" class="form-label">Task *</label>
                                <select class="form-select" id="scheduleTask" required>
                                    <option value="">Select task...</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="scheduleDueDate" class="form-label">Due Date *</label>
                                    <input type="date" class="form-control" id="scheduleDueDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="scheduleTime" class="form-label">Time (Optional)</label>
                                    <input type="time" class="form-control" id="scheduleTime">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="schedulePriority" class="form-label">Priority</label>
                                <select class="form-select" id="schedulePriority">
                                    <option value="normal">Normal</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="scheduleNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="scheduleNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="handleScheduleTask(event)">Schedule Task</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Edit Scheduled Task Modal -->
    <div class="modal fade" id="editScheduledTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Scheduled Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                                    <div class="modal-body">
                    <form id="editScheduledTaskForm">
                        <input type="hidden" id="editTaskId">
                        <div class="mb-3">
                            <label for="editTaskCluster" class="form-label">Site *</label>
                            <select class="form-select" id="editTaskCluster" required>
                                <option value="">Select site...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskType" class="form-label">Task *</label>
                            <select class="form-select" id="editTaskType" required>
                                <option value="">Select task...</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editTaskDate" class="form-label">Due Date *</label>
                                <input type="date" class="form-control" id="editTaskDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editTaskTime" class="form-label">Time (Optional)</label>
                                <input type="time" class="form-control" id="editTaskTime">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskPriority" class="form-label">Priority</label>
                            <select class="form-select" id="editTaskPriority">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editTaskNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editTaskNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="handleEditScheduledTask()">Update Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Popup Modal -->
    <div class="modal fade" id="welcomeModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--glass); backdrop-filter: blur(12px) saturate(1.1); border: 1px solid rgba(255,255,255,0.2);">
                <div class="modal-header border-0">
                    <h5 class="modal-title d-flex align-items-center">
                        <i class="bi bi-hexagon-fill me-2" style="color: var(--accent); font-size: 1.5rem;"></i>
                        Welcome to BeeMarshall
                    </h5>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="mb-3" id="welcomeUserName">Dashboard Loaded Successfully!</h4>
                    <p class="text-muted mb-4" id="welcomeMessage">
                        Your apiary management system is ready. All data has been synchronized and the dashboard is fully operational.
                    </p>
                    
                    <!-- Data Sync Status -->
                    <div class="alert alert-success border-0" style="background: rgba(40, 167, 69, 0.1);">
                        <div class="d-flex flex-column align-items-center justify-content-center">
                            <div class="d-flex align-items-center mb-1">
                                <i class="bi bi-check-circle-fill text-success me-2"></i>
                                <span class="fw-semibold">Data synchronised</span>
                            </div>
                            <small class="text-muted" id="syncTimestamp">Last updated: <span id="syncTime"></span></small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-success hexagon-button" data-bs-dismiss="modal" onclick="dismissWelcomeModal()">
                        <div class="hexagon-content">
                            <span class="hexagon-text">continue</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- BeeMarshall Modules v0.98 -->
    <!-- Environment Management -->
    <script src="js/utils.js"></script>
    <!-- Form Validation System -->
    <script src="js/form-validation.js"></script>
    <!-- BeeMarshall JavaScript Modules -->
    <script src="js/permissions.js"></script>
    <script src="js/scheduling.js"></script>
    <script src="js/compliance.js"></script>
    <script src="js/calendar-feed.js"></script>
    <script src="js/clusters.js"></script>
    <script src="js/actions.js"></script>
    <script src="js/employees.js"></script>

    <script src="js/navigation.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/core.js"></script>
    <script src="js/tasks.js"></script>
    
    <!-- Immediate test to verify JavaScript loading -->
    <script>
        console.log('🧪 HTML script test - JavaScript is working');
        window.htmlTestFunction = function() {
            console.log('✅ HTML test function called successfully');
            alert('JavaScript is working! Test buttons should be functional.');
        };
    </script>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration - Corrected to use LarsBees project
        const firebaseConfig = {
            apiKey: "AIzaSyBLqjik76P7c72rgrMvo1lw86G3MOIIuNA",
            authDomain: "beemarshall-a311e.firebaseapp.com",
            databaseURL: "https://beemarshall-a311e-default-rtdb.firebaseio.com",
            projectId: "beemarshall-a311e",
            storageBucket: "beemarshall-a311e.firebasestorage.app",
            messagingSenderId: "502475319497",
            appId: "1:502475319497:web:36e8120b0ca2c997870518",
            measurementId: "G-4WMTWPWWFD"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Map activation function
        function activateMap() {
            console.log('🗺️ Activating map...');
            
            // Hide placeholder and show map
            document.getElementById('mapPlaceholder').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            
            // Check if map is already initialized
            if (window.beeMarshallMap) {
                console.log('🗺️ Map already initialized, refreshing markers...');
                // Clear existing markers
                if (window.beeMarshallMarkers) {
                    window.beeMarshallMarkers.forEach(marker => marker.remove());
                    window.beeMarshallMarkers = [];
                }
                // Re-render clusters
                renderClustersOnMap();
                return;
            }
            
            // Initialize Leaflet map
            if (typeof L !== 'undefined') {
                window.beeMarshallMap = L.map('map', {
                    center: [-40.6781, 172.6886], // Collingwood, NZ
                    zoom: 13,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Add OpenStreetMap tiles with better loading
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19,
                    tileSize: 256,
                    zoomOffset: 0
                }).addTo(window.beeMarshallMap);
                
                console.log('🗺️ Map initialized successfully');
                
                // Wait for map to be ready
                window.beeMarshallMap.whenReady(() => {
                    console.log('🗺️ Map container ready, waiting for tiles...');
                    
                    // Wait for tiles to load completely
                    tileLayer.on('load', () => {
                        console.log('🗺️ Map tiles fully loaded, adding cluster markers...');
                        // Small delay to ensure tiles are rendered
                        setTimeout(() => {
                            renderClustersOnMap();
                        }, 500);
                    });
                    
                    // Fallback timeout in case tiles don't load
                    setTimeout(() => {
                        console.log('🗺️ Fallback: Adding markers after timeout...');
                        renderClustersOnMap();
                    }, 3000);
                });
                
                console.log('✅ Map activated successfully');
            } else {
                console.error('❌ Leaflet library not loaded');
            }
        }
        
        // Function to render clusters on map with proper marker management
        function renderClustersOnMap() {
            if (!window.beeMarshallMap) {
                console.log('🗺️ Map not initialized, skipping marker rendering');
                return;
            }
            
            // Clear existing markers
            if (window.beeMarshallMarkers) {
                window.beeMarshallMarkers.forEach(marker => marker.remove());
                window.beeMarshallMarkers = [];
            }
            
            // Initialize markers array
            window.beeMarshallMarkers = [];
            
            // Add cluster markers
            if (typeof clusters !== 'undefined' && clusters.length > 0) {
                console.log(`📍 Rendering ${clusters.length} cluster markers...`);
                
                clusters.forEach(cluster => {
                    // Use latitude/longitude instead of lat/lng
                    const lat = cluster.latitude || cluster.lat;
                    const lng = cluster.longitude || cluster.lng;
                    
                    if (lat && lng) {
                        // Get cluster type info for color-coding
                        const CLUSTER_TYPES = {
                            'production': { name: 'Production', color: '#28a745', icon: 'bi-briefcase' },
                            'nucleus': { name: 'NUC', color: '#ffc107', icon: 'bi-layer-forward' },
                            'breeding': { name: 'Breeding', color: '#dc3545', icon: 'bi-heart' },
                            'research': { name: 'Research', color: '#17a2b8', icon: 'bi-flask' },
                            'custom': { name: 'Custom', color: '#6c757d', icon: 'bi-geo-alt' }
                        };
                        
                        const typeInfo = CLUSTER_TYPES[cluster.clusterType] || CLUSTER_TYPES['custom'];
                        
                        // Get pending tasks for this site
                        const clusterTasks = (typeof scheduledTasks !== 'undefined' && scheduledTasks) 
                            ? scheduledTasks.filter(task => task.clusterId === cluster.id && !task.completed)
                                                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate))
                            : [];
                        
                        // Create custom icon with site type color
                        const customIcon = L.divIcon({
                            className: 'custom-cluster-marker',
                            html: `<div style="
                                background-color: ${typeInfo.color};
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 2px solid white;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                            "><i class="bi ${typeInfo.icon}"></i></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const marker = L.marker([lat, lng], { icon: customIcon })
                            .addTo(window.beeMarshallMap)
                            .bindPopup(`
                                <div style="padding:10px; min-width:250px;">
                                    <h6>
                                        <a href="#" onclick="showClusters(); return false;" style="color: ${typeInfo.color}; text-decoration: none; font-weight: bold; cursor: pointer;">
                                            <i class="bi ${typeInfo.icon}"></i> ${cluster.name}
                                        </a>
                                    </h6>
                                    <p class="mb-1"><small>${cluster.description || 'No description'}</small></p>
                                    <p class="mb-1"><strong>Type:</strong> <span style="color: ${typeInfo.color};">${typeInfo.name}</span></p>
                                    <p class="mb-1"><strong>Hives:</strong> ${cluster.hiveCount || 0}</p>
                                    ${cluster.harvestTimeline ? `<p class="mb-1"><strong>Harvest:</strong> ${cluster.harvestTimeline}</p>` : ''}
                                    ${cluster.sugarRequirements ? `<p class="mb-1"><strong>Sugar:</strong> ${cluster.sugarRequirements}</p>` : ''}
                                    ${cluster.landownerName ? `<p class="mb-1"><strong>Landowner:</strong> ${cluster.landownerName}</p>` : ''}
                                    
                                    ${clusterTasks.length > 0 ? `
                                        <div class="mt-3">
                                            <h6 class="mb-2"><i class="bi bi-list-check"></i> Pending Tasks (${clusterTasks.length})</h6>
                                            <div class="pending-tasks-list" style="max-height: 150px; overflow-y: auto;">
                                                ${clusterTasks.slice(0, 5).map(task => {
                                                    const dueDate = new Date(task.dueDate);
                                                    const isOverdue = dueDate < new Date();
                                                    const priorityClass = task.priority === 'urgent' ? 'danger' : task.priority === 'high' ? 'warning' : 'secondary';
                                                    
                                                    return `
                                                        <div class="pending-task-item mb-2 p-2" style="border-left: 3px solid var(--${priorityClass}); background: rgba(0,0,0,0.05); border-radius: 3px;">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <strong style="font-size: 0.85rem;">${task.taskName || 'Task'}</strong>
                                                                    <br><small class="text-muted">Due: ${dueDate.toLocaleDateString()}</small>
                                                                    ${isOverdue ? '<br><span class="badge bg-danger" style="font-size: 0.7rem;">OVERDUE</span>' : ''}
                                                                    ${task.priority !== 'normal' ? `<br><span class="badge bg-${priorityClass}" style="font-size: 0.7rem;">${task.priority.toUpperCase()}</span>` : ''}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                                ${clusterTasks.length > 5 ? `<small class="text-muted">... and ${clusterTasks.length - 5} more tasks</small>` : ''}
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="mt-3">
                                            <p class="text-muted mb-0"><i class="bi bi-check-circle"></i> No pending tasks</p>
                                        </div>
                                    `}
                                    
                                    <div class="mt-3 d-grid gap-1">
                                        <button class="btn btn-sm btn-primary" onclick="showClusters(); return false;">
                                            <i class="bi bi-eye"></i> View Details
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="if(typeof openInMaps === 'function') { openInMaps(${cluster.id}); } return false;">
                                            <i class="bi bi-geo-alt-fill"></i> View on Maps
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="if(typeof scheduleTaskForCluster === 'function') { scheduleTaskForCluster(${cluster.id}); } return false;">
                                            <i class="bi bi-calendar-plus"></i> Schedule Task
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="if(typeof editCluster === 'function') { editCluster(${cluster.id}); } return false;">
                                            <i class="bi bi-pencil"></i> Edit Site
                                        </button>
                                        ${clusterTasks.length > 0 ? `
                                            <button class="btn btn-sm btn-outline-info" onclick="if(typeof showScheduledTasks === 'function') { showScheduledTasks(); } return false;">
                                                <i class="bi bi-list-check"></i> View All Tasks
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `, {
                                maxWidth: 300,
                                className: 'cluster-popup'
                            });
                        
                        window.beeMarshallMarkers.push(marker);
                        console.log(`✅ Added marker for ${cluster.name} at [${lat}, ${lng}]`);
                    } else {
                        console.log(`⚠️ Cluster ${cluster.name} missing coordinates: lat=${cluster.latitude}, lng=${cluster.longitude}`);
                    }
                });
                
                console.log(`📍 Added ${window.beeMarshallMarkers.length} cluster markers`);
            } else {
                console.log('📍 No clusters to render on map');
            }
        }
        
        // Hive strength breakdown functions
        function updateHiveStrengthTotals() {
            const totalHives = parseInt(document.getElementById('clusterHiveCount').value) || 0;
            const strong = parseInt(document.getElementById('hiveStrong').value) || 0;
            const medium = parseInt(document.getElementById('hiveMedium').value) || 0;
            const weak = parseInt(document.getElementById('hiveWeak').value) || 0;
            const nuc = parseInt(document.getElementById('hiveNUC').value) || 0;
            const dead = parseInt(document.getElementById('hiveDead').value) || 0;
            
            const breakdownTotal = strong + medium + weak + nuc + dead;
            const totalElement = document.getElementById('hiveStrengthTotal');
            const statusElement = document.getElementById('hiveStrengthStatus');
            
            if (totalElement) {
                totalElement.textContent = breakdownTotal;
            }
            
            if (statusElement) {
                if (breakdownTotal === 0) {
                    statusElement.textContent = 'Enter hive counts above';
                    statusElement.className = 'text-muted';
                } else if (breakdownTotal === totalHives) {
                    statusElement.textContent = '✅ Breakdown matches total hive count';
                    statusElement.className = 'text-success';
                } else if (breakdownTotal < totalHives) {
                    statusElement.textContent = `⚠️ Breakdown (${breakdownTotal}) is less than total (${totalHives})`;
                    statusElement.className = 'text-warning';
                } else {
                    statusElement.textContent = `❌ Breakdown (${breakdownTotal}) exceeds total (${totalHives})`;
                    statusElement.className = 'text-danger';
                }
            }
            
            // Update detailed breakdown summary
            updateDetailedBreakdown(strong, medium, weak, nuc, dead, totalHives);
        }
        
        function updateDetailedBreakdown(strong, medium, weak, nuc, dead, totalHives) {
            const breakdownSummary = document.getElementById('hiveBreakdownSummary');
            const stackSummary = document.getElementById('stackBreakdownSummary');
            
            // Show breakdown summary if there are any hives
            if (strong + medium + weak + nuc + dead > 0) {
                breakdownSummary.style.display = 'block';
                
                // Update progress bars
                const maxValue = Math.max(strong, medium, weak, nuc, dead, 1);
                document.getElementById('strongProgress').style.width = `${(strong / maxValue) * 100}%`;
                document.getElementById('mediumProgress').style.width = `${(medium / maxValue) * 100}%`;
                document.getElementById('weakProgress').style.width = `${(weak / maxValue) * 100}%`;
                document.getElementById('nucProgress').style.width = `${(nuc / maxValue) * 100}%`;
                document.getElementById('deadProgress').style.width = `${(dead / maxValue) * 100}%`;
                document.getElementById('emptyProgress').style.width = `0%`; // Empty platforms handled separately
            } else {
                breakdownSummary.style.display = 'none';
            }
            
            // Update stack configuration summary
            updateStackBreakdownSummary();
        }
        
        // Auto-distribute hives when total count changes
        function autoDistributeHives() {
            const totalHives = parseInt(document.getElementById('clusterHiveCount').value) || 0;
            if (totalHives > 0) {
                // Suggest a proportional distribution
                const strong = Math.round(totalHives * 0.4); // 40% strong
                const medium = Math.round(totalHives * 0.3); // 30% medium
                const weak = Math.round(totalHives * 0.2); // 20% weak
                const nuc = Math.round(totalHives * 0.05); // 5% NUC
                const dead = Math.round(totalHives * 0.05); // 5% dead
                
                document.getElementById('hiveStrong').value = strong;
                document.getElementById('hiveMedium').value = medium;
                document.getElementById('hiveWeak').value = weak;
                document.getElementById('hiveNUC').value = nuc;
                document.getElementById('hiveDead').value = dead;
                
                updateHiveStrengthTotals();
            }
        }
        
        // Stack configuration functions
        function updateStackTotals() {
            const doubles = parseInt(document.getElementById('stackDoubles').value) || 0;
            const topSplits = parseInt(document.getElementById('stackTopSplits').value) || 0;
            const singles = parseInt(document.getElementById('stackSingles').value) || 0;
            const nucs = parseInt(document.getElementById('stackNUCs').value) || 0;
            const empty = parseInt(document.getElementById('stackEmpty').value) || 0;
            
            const stackTotal = doubles + topSplits + singles + nucs + empty;
            const totalElement = document.getElementById('stackTotal');
            const statusElement = document.getElementById('stackStatus');
            
            if (totalElement) {
                totalElement.textContent = stackTotal;
            }
            
            if (statusElement) {
                if (stackTotal === 0) {
                    statusElement.textContent = 'Enter stack counts above';
                    statusElement.className = 'text-muted';
                } else {
                    statusElement.textContent = `📊 Stack breakdown: ${doubles} doubles, ${topSplits} top-splits, ${singles} singles, ${nucs} NUCs, ${empty} empty`;
                    statusElement.className = 'text-info';
                }
            }
            
            // Update stack breakdown summary
            updateStackBreakdownSummary();
        }
        
        function updateStackBreakdownSummary() {
            const doubles = parseInt(document.getElementById('stackDoubles').value) || 0;
            const topSplits = parseInt(document.getElementById('stackTopSplits').value) || 0;
            const singles = parseInt(document.getElementById('stackSingles').value) || 0;
            const nucs = parseInt(document.getElementById('stackNUCs').value) || 0;
            const empty = parseInt(document.getElementById('stackEmpty').value) || 0;
            
            const stackSummary = document.getElementById('stackBreakdownSummary');
            
            // Show stack summary if there are any stacks
            if (doubles + topSplits + singles + nucs + empty > 0) {
                stackSummary.style.display = 'block';
                
                // Update stack counts
                document.getElementById('doublesCount').textContent = doubles;
                document.getElementById('topSplitsCount').textContent = topSplits;
                document.getElementById('singlesCount').textContent = singles;
                document.getElementById('nucsCount').textContent = nucs;
                document.getElementById('emptyStacksCount').textContent = empty;
            } else {
                stackSummary.style.display = 'none';
            }
        }
        
        // Auto-distribute stacks when total count changes
        function autoDistributeStacks() {
            const totalHives = parseInt(document.getElementById('clusterHiveCount').value) || 0;
            if (totalHives > 0) {
                // Suggest a proportional stack distribution
                const doubles = Math.round(totalHives * 0.3); // 30% doubles
                const topSplits = Math.round(totalHives * 0.2); // 20% top-splits
                const singles = Math.round(totalHives * 0.4); // 40% singles
                const nucs = Math.round(totalHives * 0.05); // 5% NUCs
                const empty = Math.round(totalHives * 0.05); // 5% empty
                
                document.getElementById('stackDoubles').value = doubles;
                document.getElementById('stackTopSplits').value = topSplits;
                document.getElementById('stackSingles').value = singles;
                document.getElementById('stackNUCs').value = nucs;
                document.getElementById('stackEmpty').value = empty;
                
                updateStackTotals();
            }
        }
        
        // CSV Export Functions
        function exportClustersCSV() {
            if (!clusters || clusters.length === 0) {
                beeMarshallAlert('No site data available to export.', 'info');
                return;
            }
            
            const csvData = clusters.map(cluster => {
                return {
                    'Site ID': cluster.id,
                    'Name': cluster.name,
                    'Description': cluster.description || '',
                    'Latitude': cluster.latitude,
                    'Longitude': cluster.longitude,
                    'Total Hives': cluster.hiveCount,
                    'Strong Hives': cluster.hiveStrength?.strong || 0,
                    'Medium Hives': cluster.hiveStrength?.medium || 0,
                    'Weak Hives': cluster.hiveStrength?.weak || 0,
                    'NUC Hives': cluster.hiveStrength?.nuc || 0,
                    'Dead Hives': cluster.hiveStrength?.dead || 0,
                    'Double Stacks': cluster.hiveStacks?.doubles || 0,
                    'Top-Splits': cluster.hiveStacks?.topSplits || 0,
                    'Single Stacks': cluster.hiveStacks?.singles || 0,
                    'NUC Stacks': cluster.hiveStacks?.nucs || 0,
                    'Empty Platforms': cluster.hiveStacks?.empty || 0,
                    'Site Type': cluster.clusterType || '',
                    'Landowner Name': cluster.landownerName || '',
                    'Landowner Phone': cluster.landownerPhone || '',
                    'Landowner Email': cluster.landownerEmail || '',
                    'Landowner Address': cluster.landownerAddress || '',
                    'Site Type': cluster.siteType || '',
                    'Access Type': cluster.accessType || '',
                    'Contact Before Visit': cluster.contactBeforeVisit ? 'Yes' : 'No',
                    'Quarantine': cluster.isQuarantine ? 'Yes' : 'No',
                    'Harvest Timeline': cluster.harvestTimeline || '',
                    'Sugar Requirements': cluster.sugarRequirements || '',
                    'Notes': cluster.notes || '',
                    'Created At': cluster.createdAt || '',
                    'Last Modified By': cluster.lastModifiedBy || '',
                    'Last Modified At': cluster.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `clusters_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportActionsCSV() {
            if (!actions || actions.length === 0) {
                beeMarshallAlert('No action data available to export.', 'info');
                return;
            }
            
            const csvData = actions.map(action => {
                // Find site name from ID
                const cluster = clusters.find(c => c.id === action.clusterId);
                const clusterName = cluster ? cluster.name : '';
                
                return {
                    'Action ID': action.id,
                    'Date': action.date || '',
                    'Site ID': action.clusterId || '',
                    'Site Name': clusterName,
                    'Task ID': action.taskId || '',
                    'Task Name': action.taskName || '',
                    'Task Category': action.taskCategory || '',
                    'Individual Hive ID': action.individualHiveId || '',
                    'Notes': action.notes || '',
                    'Flag': action.flag || '',
                    'Logged By': action.loggedBy || '',
                    'Created At': action.createdAt || '',
                    'From Scheduled Task': action.fromScheduledTask ? 'Yes' : 'No',
                    'Original Scheduled Task ID': action.originalScheduledTaskId || ''
                };
            });
            
            downloadCSV(csvData, `actions_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportScheduledTasksCSV() {
            if (!scheduledTasks || scheduledTasks.length === 0) {
                beeMarshallAlert('No scheduled task data available to export.', 'info');
                return;
            }
            
            const csvData = scheduledTasks.map(task => {
                // Find site name from ID
                const cluster = clusters.find(c => c.id === task.clusterId);
                const clusterName = cluster ? cluster.name : '';
                
                // Find task name from task ID
                const taskObj = tasks.find(t => t.id === task.taskId);
                const taskName = taskObj ? taskObj.name : '';
                const taskCategory = taskObj ? taskObj.category : '';
                
                return {
                    'Task ID': task.id,
                    'Task Type ID': task.taskId || '',
                    'Task Name': taskName,
                    'Task Category': taskCategory,
                    'Site ID': task.clusterId || '',
                    'Site Name': clusterName,
                    'Individual Hive ID': task.individualHiveId || '',
                    'Due Date': task.dueDate || '',
                    'Scheduled Time': task.scheduledTime || '',
                    'Priority': task.priority || '',
                    'Status': task.completed ? 'Completed' : 'Pending',
                    'Notes': task.notes || '',
                    'Overdue': task.overdue ? 'Yes' : 'No',
                    'Overdue Date': task.overdueDate || '',
                    'Created By': task.createdBy || '',
                    'Created At': task.createdAt || '',
                    'Completed By': task.completedBy || '',
                    'Completed At': task.completedAt || '',
                    'Last Modified By': task.lastModifiedBy || '',
                    'Last Modified At': task.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `scheduled_tasks_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportIndividualHivesCSV() {
            if (!individualHives || individualHives.length === 0) {
                beeMarshallAlert('No individual hive data available to export.', 'info');
                return;
            }
            
            const csvData = individualHives.map(hive => {
                // Find site name from ID
                const cluster = clusters.find(c => c.id === hive.clusterId);
                const clusterName = cluster ? cluster.name : '';
                
                return {
                    'Hive ID': hive.id,
                    'Site ID': hive.clusterId || '',
                    'Site Name': clusterName,
                    'Hive Name': hive.hiveName || '',
                    'Hive Number': hive.hiveNumber || '',
                    'Status': hive.status || '',
                    'Queen Status': hive.queenStatus || '',
                    'Brood Pattern': hive.broodPattern || '',
                    'Food Stores': hive.foodStores || '',
                    'Population': hive.population || '',
                    'Notes': hive.notes || '',
                    'Created At': hive.createdAt || '',
                    'Last Modified At': hive.lastModifiedAt || ''
                };
            });
            
            downloadCSV(csvData, `individual_hives_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function exportAllDataCSV() {
            const allData = [];
            
            // Add sites data
            if (clusters && clusters.length > 0) {
                clusters.forEach(cluster => {
                    allData.push({
                        'Data Type': 'Site',
                        'ID': cluster.id,
                        'Name': cluster.name,
                        'Description': cluster.description || '',
                        'Latitude': cluster.latitude,
                        'Longitude': cluster.longitude,
                        'Total Hives': cluster.hiveCount,
                        'Strong Hives': cluster.hiveStrength?.strong || 0,
                        'Medium Hives': cluster.hiveStrength?.medium || 0,
                        'Weak Hives': cluster.hiveStrength?.weak || 0,
                        'NUC Hives': cluster.hiveStrength?.nuc || 0,
                        'Dead Hives': cluster.hiveStrength?.dead || 0,
                        'Double Stacks': cluster.hiveStacks?.doubles || 0,
                        'Top-Splits': cluster.hiveStacks?.topSplits || 0,
                        'Single Stacks': cluster.hiveStacks?.singles || 0,
                        'NUC Stacks': cluster.hiveStacks?.nucs || 0,
                        'Empty Platforms': cluster.hiveStacks?.empty || 0,
                        'Site Type': cluster.clusterType || '',
                        'Landowner Name': cluster.landownerName || '',
                        'Landowner Phone': cluster.landownerPhone || '',
                        'Landowner Email': cluster.landownerEmail || '',
                        'Landowner Address': cluster.landownerAddress || '',
                        'Site Type': cluster.siteType || '',
                        'Access Type': cluster.accessType || '',
                        'Contact Before Visit': cluster.contactBeforeVisit ? 'Yes' : 'No',
                        'Quarantine': cluster.isQuarantine ? 'Yes' : 'No',
                        'Harvest Timeline': cluster.harvestTimeline || '',
                        'Sugar Requirements': cluster.sugarRequirements || '',
                        'Notes': cluster.notes || '',
                        'Created At': cluster.createdAt || '',
                        'Last Modified By': cluster.lastModifiedBy || '',
                        'Last Modified At': cluster.lastModifiedAt || ''
                    });
                });
            }
            
            // Add actions data
            if (actions && actions.length > 0) {
                actions.forEach(action => {
                    allData.push({
                        'Data Type': 'Action',
                        'ID': action.id,
                        'Name': action.clusterName || '',
                        'Description': action.description || '',
                        'Action Type': action.actionType || '',
                        'Date': action.date || '',
                        'Time': action.time || '',
                        'Performed By': action.performedBy || '',
                        'Hive Count': action.hiveCount || '',
                        'Honey Harvested': action.honeyHarvested || '',
                        'Sugar Fed': action.sugarFed || '',
                        'Disease Found': action.diseaseFound || '',
                        'Disease Type': action.diseaseType || '',
                        'Treatment Applied': action.treatmentApplied || '',
                        'Weather': action.weather || '',
                        'Temperature': action.temperature || '',
                        'Notes': action.notes || '',
                        'Flag': action.flag || '',
                        'Created At': action.createdAt || '',
                        'Last Modified By': '',
                        'Last Modified At': ''
                    });
                });
            }
            
            // Add scheduled tasks data
            if (scheduledTasks && scheduledTasks.length > 0) {
                scheduledTasks.forEach(task => {
                    allData.push({
                        'Data Type': 'Scheduled Task',
                        'ID': task.id,
                        'Name': task.title || '',
                        'Description': task.description || '',
                        'Due Date': task.dueDate || '',
                        'Priority': task.priority || '',
                        'Site Name': task.clusterName || '',
                        'Assigned To': task.assignedTo || '',
                        'Status': task.completed ? 'Completed' : 'Pending',
                        'Completed At': task.completedAt || '',
                        'Created At': task.createdAt || '',
                        'Last Modified By': '',
                        'Last Modified At': ''
                    });
                });
            }
            
            if (allData.length === 0) {
                beeMarshallAlert('No data available to export.', 'info');
                return;
            }
            
            downloadCSV(allData, `beemarshall_complete_export_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                beeMarshallAlert('No data to export.', 'info');
                return;
            }
            
            // Convert data to CSV format
            const headers = Object.keys(data[0]);
            
            // Create CSV content with header information
            const exportInfo = [
                `BeeMarshall Data Export`,
                `Exported By: ${typeof currentUser !== 'undefined' && currentUser ? currentUser.username : 'Unknown'}`,
                `Export Date: ${new Date().toISOString()}`,
                `Tenant: ${typeof currentTenantId !== 'undefined' && currentTenantId ? currentTenantId : 'N/A'}`,
                `Total Records: ${data.length}`,
                `Sites (Clusters): ${typeof clusters !== 'undefined' && clusters ? clusters.length : 0}`,
                `Actions: ${typeof actions !== 'undefined' && actions ? actions.length : 0}`,
                `Scheduled Tasks: ${typeof scheduledTasks !== 'undefined' && scheduledTasks ? scheduledTasks.length : 0}`,
                `Individual Hives: ${typeof individualHives !== 'undefined' && individualHives ? individualHives.length : 0}`,
                ``, // Empty line before data
            ];
            
            const csvContent = [
                exportInfo.join('\n'),
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // Escape commas and quotes in CSV
                        return `"${String(value).replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`📊 CSV exported: ${filename} (${data.length} records)`);
            beeMarshallAlert(`CSV exported successfully!\n\nFile: ${filename}\nRecords: ${data.length}\nUser: ${currentUser ? currentUser.username : 'Unknown'}`, 'success');
        }
        
        
        // Handle navigation from reports
        function handleReportsNavigation() {
            const navigateToCluster = localStorage.getItem('navigateToCluster');
            const scheduleTaskData = localStorage.getItem('scheduleTaskForCluster');
            
            if (navigateToCluster) {
                localStorage.removeItem('navigateToCluster');
                // Navigate to clusters view and highlight specific cluster
                showClusters();
                setTimeout(() => {
                    const clusterElement = document.querySelector(`[data-cluster-id="${navigateToCluster}"]`);
                    if (clusterElement) {
                        clusterElement.scrollIntoView({ behavior: 'smooth' });
                        clusterElement.style.border = '2px solid var(--accent)';
                        clusterElement.style.boxShadow = '0 0 20px rgba(255, 193, 7, 0.5)';
                    }
                }, 1000);
            }
            
            if (scheduleTaskData) {
                const data = JSON.parse(scheduleTaskData);
                localStorage.removeItem('scheduleTaskForCluster');
                // Navigate to scheduled tasks and pre-fill form
                showScheduledTasks();
                setTimeout(() => {
                    // Pre-fill task form with suggested tasks
                    const taskForm = document.getElementById('taskForm');
                    if (taskForm && data.suggestedTasks) {
                        const taskTitle = document.getElementById('taskTitle');
                        const taskDescription = document.getElementById('taskDescription');
                        if (taskTitle) taskTitle.value = data.suggestedTasks[0] || 'Scheduled Task';
                        if (taskDescription) taskDescription.value = `Task for cluster ${data.clusterId} - ${data.category} hives`;
                    }
                }, 1000);
            }
        }
        
        // Initialize dashboard functionality after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Make dashboard cards clickable
            setTimeout(() => {
                makeDashboardCardsClickable();
                makeRecentActionsClickable();
            }, 1000);
            
            // Add auto-distribute button
            const hiveCountField = document.getElementById('clusterHiveCount');
            if (hiveCountField) {
                hiveCountField.addEventListener('change', autoDistributeHives);
            }
            
            // Handle reports navigation
            handleReportsNavigation();
            
            // Auto-collapse mobile navbar menu after 5 seconds
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.getElementById('navbarNav');
            
            if (navbarToggler && navbarCollapse) {
                let collapseTimeout = null;
                
                // Listen for the navbar being shown
                navbarCollapse.addEventListener('shown.bs.collapse', function() {
                    // Clear any existing timeout
                    if (collapseTimeout) {
                        clearTimeout(collapseTimeout);
                    }
                    
                    // Set new timeout to collapse after 5 seconds
                    collapseTimeout = setTimeout(function() {
                        const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                        if (bsCollapse) {
                            bsCollapse.hide();
                        }
                    }, 5000);
                });
                
                // Clear timeout when user manually closes the menu
                navbarCollapse.addEventListener('hidden.bs.collapse', function() {
                    if (collapseTimeout) {
                        clearTimeout(collapseTimeout);
                        collapseTimeout = null;
                    }
                });
            }
        });
    </script>
</body>
</html>