<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeeMarshall Scheduled Tasks Calendar Feed</title>
</head>
<body>
    <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px;">
        <h1>üêù BeeMarshall Scheduled Tasks Calendar</h1>
        <p>Loading calendar feed from Firebase...</p>
        <div id="status">Connecting to database...</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyALV0NmXT2VIZBrAR6D7rSnphNljhFIeb0",
            authDomain: "larsbees-378aa.firebaseapp.com",
            databaseURL: "https://larsbees-378aa-default-rtdb.firebaseio.com",
            projectId: "larsbees-378aa",
            storageBucket: "larsbees-378aa.firebasestorage.app",
            messagingSenderId: "101401288589",
            appId: "1:101401288589:web:a4208c078ec609364fe7c4",
            measurementId: "G-KYV5R1YJBB"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Load data and generate ICS
        Promise.all([
            database.ref('scheduledTasks').once('value'),
            database.ref('clusters').once('value'),
            database.ref('tasks').once('value')
        ]).then(([tasksSnapshot, clustersSnapshot, taskDefsSnapshot]) => {
            const scheduledTasks = tasksSnapshot.val() ? Object.values(tasksSnapshot.val()) : [];
            const clusters = clustersSnapshot.val() ? Object.values(clustersSnapshot.val()) : [];
            const tasks = taskDefsSnapshot.val() ? Object.values(taskDefsSnapshot.val()) : [];
            
            const icsContent = generateICS(scheduledTasks, clusters, tasks);
            
            // Serve as ICS file
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // Auto-download
            const link = document.createElement('a');
            link.href = url;
            link.download = 'larsbees-scheduled-tasks.ics';
            link.click();
            
            document.getElementById('status').innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 5px; color: #155724;">
                    <h3>‚úÖ Calendar Feed Generated!</h3>
                    <p>The .ics file has been downloaded with ${scheduledTasks.length} scheduled task(s).</p>
                    <p><strong>Bookmark this page</strong> and visit it anytime to get the latest scheduled tasks!</p>
                    <p style="margin-top: 15px;"><small>This page always fetches the latest data from BeeMarshall.</small></p>
                </div>
            `;
        }).catch(error => {
            document.getElementById('status').innerHTML = `
                <div style="background: #f8d7da; padding: 15px; border-radius: 5px; color: #721c24;">
                    <h3>‚ùå Error Loading Calendar</h3>
                    <p>Could not connect to database: ${error.message}</p>
                </div>
            `;
        });

        function generateICS(scheduledTasks, clusters, tasks) {
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//BeeMarshall//Scheduled Tasks//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:BeeMarshall Scheduled Tasks',
                'X-WR-TIMEZONE:Pacific/Auckland',
                'X-WR-CALDESC:Scheduled beekeeping tasks from BeeMarshall'
            ];
            
            scheduledTasks.filter(t => !t.completed).forEach(task => {
                const cluster = clusters.find(c => c.id === task.clusterId);
                const taskDef = tasks.find(td => td.id === task.taskId);
                
                const taskName = taskDef ? taskDef.name : 'Scheduled Task';
                const clusterName = cluster ? cluster.name : 'Unknown Location';
                
                const event = [
                    'BEGIN:VEVENT',
                    `UID:scheduled-${task.id}@larsbees.app`,
                    `DTSTAMP:${formatICSTimestamp(new Date())}`,
                    `DTSTART;VALUE=DATE:${formatICSDate(new Date(task.dueDate || task.scheduledDate))}`,
                    `SUMMARY:${escapeICS(taskName + ' - ' + clusterName)}`,
                    `DESCRIPTION:${escapeICS(buildDescription(task, clusterName, taskName))}`,
                    `LOCATION:${escapeICS(clusterName)}`,
                    `CATEGORIES:Beekeeping,Scheduled Task,${task.priority || 'normal'}`,
                    `STATUS:CONFIRMED`,
                    `TRANSP:TRANSPARENT`,
                    `PRIORITY:${task.priority === 'urgent' ? '1' : task.priority === 'high' ? '3' : '5'}`,
                    'END:VEVENT'
                ];
                
                icsContent = icsContent.concat(event);
            });
            
            icsContent.push('END:VCALENDAR');
            
            return icsContent.join('\r\n');
        }

        function buildDescription(task, clusterName, taskName) {
            let desc = `Task: ${taskName}\\n`;
            desc += `Location: ${clusterName}\\n`;
            desc += `Priority: ${task.priority || 'normal'}\\n`;
            if (task.notes) {
                desc += `\\nNotes: ${task.notes}\\n`;
            }
            desc += `\\nScheduled in BeeMarshall Apiary Management`;
            return desc;
        }

        function formatICSDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatICSTimestamp(date) {
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const day = String(date.getUTCDate()).padStart(2, '0');
            const hour = String(date.getUTCHours()).padStart(2, '0');
            const minute = String(date.getUTCMinutes()).padStart(2, '0');
            const second = String(date.getUTCSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hour}${minute}${second}Z`;
        }

        function escapeICS(text) {
            if (!text) return '';
            return text
                .replace(/\\/g, '\\\\')
                .replace(/;/g, '\\;')
                .replace(/,/g, '\\,')
                .replace(/\n/g, '\\n');
        }
    </script>
</body>
</html>

