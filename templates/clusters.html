{% extends "base.html" %}

{% block title %}Hive Clusters - BeeMarshall{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-5"><i class="bi bi-geo-alt"></i> Hive Clusters</h1>
        <p class="lead text-muted">Manage your hive locations</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('add_cluster') }}" class="btn btn-warning btn-lg">
            <i class="bi bi-plus-circle"></i> Add New Cluster
        </a>
    </div>
</div>

<!-- Map View -->
<div class="card mb-4">
    <div class="card-header bg-warning">
        <h5 class="mb-0"><i class="bi bi-map"></i> Cluster Map</h5>
    </div>
    <div class="card-body p-0">
        <div id="map" style="height: 500px; width: 100%;"></div>
    </div>
</div>

<!-- Cluster List -->
<div class="card">
    <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-list"></i> All Clusters</h5>
    </div>
    <div class="card-body">
        {% if clusters %}
        <div class="row">
            {% for cluster in clusters %}
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-geo-alt-fill text-warning"></i> {{ cluster.name }}
                        </h5>
                        <p class="card-text text-muted">{{ cluster.description or 'No description' }}</p>
                        
                        <ul class="list-unstyled">
                            <li><strong>Hives:</strong> {{ cluster.hive_count }}</li>
                            {% if cluster.harvest_timeline %}
                            <li><strong>Harvest:</strong> {{ cluster.harvest_timeline }}</li>
                            {% endif %}
                            {% if cluster.sugar_requirements %}
                            <li><strong>Sugar:</strong> {{ cluster.sugar_requirements }}</li>
                            {% endif %}
                        </ul>
                        
                        <small class="text-muted">
                            <i class="bi bi-calendar"></i> Created: {{ cluster.created_at.strftime('%Y-%m-%d') }}
                        </small>
                    </div>
                    <div class="card-footer bg-light">
                        <a href="{{ url_for('cluster_detail', cluster_id=cluster.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="bi bi-eye"></i> View Details
                        </a>
                        <a href="{{ url_for('edit_cluster', cluster_id=cluster.id) }}" class="btn btn-sm btn-outline-warning">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center my-5">
            <i class="bi bi-geo-alt text-muted" style="font-size: 5rem;"></i>
            <h4 class="mt-3 text-muted">No Hive Clusters Yet</h4>
            <p class="text-muted">Add your first hive cluster to start managing your apiary.</p>
            <a href="{{ url_for('add_cluster') }}" class="btn btn-warning btn-lg mt-3">
                <i class="bi bi-plus-circle"></i> Add First Cluster
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap" async defer></script>
<script>
function initMap() {
    const center = { lat: 40.7128, lng: -74.0060 };
    
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: center,
        mapTypeId: 'terrain'
    });
    
    fetch('{{ url_for("api_clusters") }}')
        .then(response => response.json())
        .then(clusters => {
            if (clusters.length > 0) {
                map.setCenter({ lat: clusters[0].latitude, lng: clusters[0].longitude });
                
                clusters.forEach(cluster => {
                    const marker = new google.maps.Marker({
                        position: { lat: cluster.latitude, lng: cluster.longitude },
                        map: map,
                        title: cluster.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: '#FFC107',
                            fillOpacity: 0.9,
                            strokeColor: '#FF9800',
                            strokeWeight: 3
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; min-width: 200px;">
                                <h6><strong>${cluster.name}</strong></h6>
                                <p class="mb-1"><small>${cluster.description || 'No description'}</small></p>
                                <p class="mb-1"><strong>Hives:</strong> ${cluster.hive_count}</p>
                                ${cluster.harvest_timeline ? `<p class="mb-1"><strong>Harvest:</strong> ${cluster.harvest_timeline}</p>` : ''}
                                ${cluster.sugar_requirements ? `<p class="mb-1"><strong>Sugar:</strong> ${cluster.sugar_requirements}</p>` : ''}
                                <a href="/cluster/${cluster.id}" class="btn btn-sm btn-warning mt-2">View Details</a>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });
                });
                
                if (clusters.length > 1) {
                    const bounds = new google.maps.LatLngBounds();
                    clusters.forEach(cluster => {
                        bounds.extend(new google.maps.LatLng(cluster.latitude, cluster.longitude));
                    });
                    map.fitBounds(bounds);
                }
            }
        })
        .catch(error => console.error('Error loading clusters:', error));
}
</script>
{% endblock %}

